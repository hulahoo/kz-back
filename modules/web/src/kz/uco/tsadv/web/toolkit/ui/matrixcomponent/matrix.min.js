$(function(){var t=0,e=function(t,e){this.$matrixList=t,this.$options=e,this.$globalOptions=t.$options,this.$items={},this._init()};e.prototype={$matrixList:null,$el:null,$elWrapper:null,$options:{},$items:{},$globalOptions:{},$ul:null,$header:null,$title:null,$form:null,$footer:null,$body:null,eventsSuppressed:!1,_init:function(){$.blockUI({message:'<p><img src="./VAADIN/themes/tal/images/spinner.gif" /> Пожалуйста подождите, идет загрузка данных...</p>'});var e=this;e.suppressEvents(),e.$options.id||(e.$options.id="matrix-list-"+t++);var i=$('<div class="matrix-wrapper col-lg-4"></div>'),s=$('<div id="'+e.$options.id+'" class="matrix-list"></div>').appendTo(i);e.$options.defaultStyle&&s.addClass(e.$options.defaultStyle),e.$el=s,e.$elWrapper=i,e.$header=e._createHeader(),e._createTitle(),e.$body=e._createBody(),e.$ul=e._createList(),e.$options.items&&e._createItems(e.$options.items),e.$body.append(e.$ul,e.$form),e.$globalOptions.sortable&&e._enableSorting(),e.resumeEvents(),$(".matrix-item").tooltip(),$.unblockUI()},suppressEvents:function(){return this.eventsSuppressed=!0,this},resumeEvents:function(){return this.eventsSuppressed=!1,this},_processItemData:function(t){var e=this;return $.extend({},e.$globalOptions.itemOptions,t)},_createHeader:function(){var t=this,e=$("<div>",{class:"matrix-list-header"});return t.$el.append(e),e},_createTitle:function(){var t=this;null!==t.$options.title&&$("<div>",{class:"matrix-list-title",html:t.$options.title}).appendTo(t.$header),$("<div>",{class:"matrix-list-info",html:t.$options.info}).appendTo(t.$header)},_createBody:function(){var e=this,i=$("<div>",{class:"matrix-list-body"});if(1===t||4===t||7===t){var s=$("<div>",{class:"v-text",html:e.$options.vText});i.append(s),i.addClass("has-v-text")}return e.$el.append(i),i},_createList:function(){var t=this,e=$("<ul>",{class:"matrix-items clearfix",id:t.$options.listId});return t.$el.append(e),e},_createItems:function(t){for(var e=this,i=0;i<t.length;i++)e._addItem(t[i])},_addItem:function(t){var e=this;t.id||(t.id=e.$matrixList.getNextId()),!1!==e._triggerEvent("beforeItemAdd",[e,t])&&(t=e._processItemData(t),e._addItemToList(t))},_enableSorting:function(){var t=this;t.$el.find(".matrix-items").sortable({connectWith:".matrix-list .matrix-items",items:".matrix-item",handle:".drag-handler",cursor:"move",placeholder:"matrix-item-placeholder",forcePlaceholderSize:!0,opacity:.6,revert:70,update:function(e,i){t._triggerEvent("afterItemReorder",[t,i.item])},receive:function(e,i){var s={id:i.item.data("id"),from:i.sender.attr("id"),to:this.id};t._triggerEvent("afterItemReceive",[t,JSON.stringify(s)])}})},_addItemToList:function(t){var e=this,i=$("<li>",{"data-id":t.id,class:"matrix-item",title:t.title});return i.append($("<img>",{class:"matrix-item-image drag-handler",src:t.url})),i.data("matrixListItem",t),e.$ul.append(i),e.$items[t.id]=t,e._triggerEvent("afterItemAdd",[e,t]),i},_triggerEvent:function(t,e){var i=this;if(!i.eventsSuppressed)return i.$options[t]&&"function"==typeof i.$options[t]?i.$options[t].apply(i,e):i.$el.trigger(t,e)},_sendAjax:function(t,e){var i=this;return $.ajax(t,i._beforeAjaxSent(e))},_beforeAjaxSent:function(t){var e=this,i=e._triggerEvent("beforeAjaxSent",[e,t]);return $.extend({},t,i||{})}};var i=function(t,e){this.$el=t,this.init(e)};i.prototype={$el:null,$lists:[],$options:{},_nextId:1,eventsSuppressed:!1,init:function(t){var e=this;e.suppressEvents(),e.$options=this._processInput(t),e.$el.addClass("matrix row"),e.$options.onSingleLine&&e.$el.addClass("single-line"),e._createLists(),e._triggerEvent("init",[e]),e.resumeEvents()},_processInput:function(t){return(t=$.extend({},$.fn.matrixList.DEFAULT_OPTIONS,t)).actions.load&&$.ajax(t.actions.load,{async:!1}).done(function(e){t.lists=e.lists}),t},_createLists:function(){for(var t=this,e=0;e<t.$options.lists.length;e++)t.addList(t.$options.lists[e]);return t},addList:function(t){var i=this;return t instanceof e||(t=new e(i,i._processListOptions(t))),!1!==i._triggerEvent("beforeListAdd",[i,t])&&(i.$lists.push(t),i.$el.append(t.$elWrapper),t.$el.data("matrixList",t),i._triggerEvent("afterListAdd",[i,t])),t},getNextId:function(){return this._nextId++},_processListOptions:function(t){var e=this;t=$.extend({},e.$options.listsOptions,t);for(var i in e.$options)e.$options.hasOwnProperty(i)&&void 0===t[i]&&(t[i]=e.$options[i]);return t},suppressEvents:function(){return this.eventsSuppressed=!0,this},resumeEvents:function(){return this.eventsSuppressed=!1,this},_triggerEvent:function(t,e){var i=this;if(!i.eventsSuppressed)return i.$options[t]&&"function"==typeof i.$options[t]?i.$options[t].apply(i,e):i.$el.trigger(t,e)}},$.fn.matrixList=function(t){var e,s=arguments;return this.each(function(){var n=$(this),r=n.data("matrixList"),a="object"==typeof t&&t;r||n.data("matrixList",r=new i(n,a)),"string"==typeof t&&(s=Array.prototype.slice.call(s,1),e=r[t].apply(r,s))})},$.fn.matrixList.DEFAULT_OPTIONS={listsOptions:{id:!1,title:"",items:[]},itemOptions:{id:!1,title:"",url:""},lists:[],actions:{load:"",update:"",insert:"",delete:""},listId:"",sortable:!0,defaultStyle:"matrix-list-1",onSingleLine:!1,init:null,beforeListAdd:null,afterListAdd:null,beforeItemAdd:null,afterItemAdd:null,beforeItemUpdate:null,afterListReorder:null,afterItemReorder:null,beforeAjaxSent:null,afterItemReceive:null}});